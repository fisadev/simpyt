{% extends "base.html" %}
{% block body %}

<style>
    body {
        padding: 0;
        margin: 0;
        background-color: black;
    }
    #pit {
        margin: 0px;
        display: grid;
        grid-template-columns: 60% 40%;
    }
    #edit{
        height: 90vh;
        width: 100%;
    }
    #text-editor{
        display: inline-block;
        color: white;
        width: 98%;
        height: 90%;
        overflow-y: scroll;
    }
    .control {
        background-color: rgba(255, 255, 255, 0.8);
        text-align: center;
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
    }
    .control a {
        width: 100%;
        height: 100%;
        display: block;
    }
</style>

<div id="pit">
    <div id="page-controls">
        {% include "page_controls.html" %}
    </div>
    <div>
        {% if edit: %}

        <div id="edit">
            <!-- Editor -->
            <div id="text-editor"
            hx-get="/page/{{ page.name }}/code"
            hx-trigger="load"
            hx-on::after-request="loadEditableCode(JSON.parse(event.detail.xhr.response).code)"
            >
            ></div>
 
            <button hx-get="/page/{{ page.name }}/controls"
            hx-trigger="click"
            hx-target="#page-controls"
            hx-swap="innerHTML">
                Recargar
            </button>
            
            <button id="reloadButton">
                Guardar
            </button>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" type="text/javascript" charset="utf-8"></script>
            <script>
                //Editor
                var e;
                function loadEditableCode(code){
                    e=ace.edit("text-editor");
                    e.setTheme("ace/theme/terminal");
                    e.getSession().setMode("ace/mode/yaml");
                    e.focus();
                    e.setOptions({
                        fontSize: "12pt",
                        showPrintMargin: false,
                        wrap: true,
                        showGutter: true // Enable line numbers
                    });
                    const formatedCode = code.replace(/#/g, '\n#');
                    e.setValue(formatedCode, -1)
                }

                function getEditorContent() {
                    let editorContent = e.getValue()
                    let jsonData = {
                        "code": editorContent
                    };
                    return JSON.stringify(jsonData);
                }
                document.getElementById('reloadButton').addEventListener('click', function(event) {
                    event.preventDefault();
                    var jsonData = getEditorContent()
                    fetch('/page/{{ page.name }}/code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: jsonData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response:', data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
        </script>
        </div>
        {% endif %}
    </div>

</div>
<script>
    // TODO: this should also be done on reload!!
    function setGridSize() {
        var windowWidth = window.innerWidth;
        var windowHeight = window.innerHeight;

        var maxColWidth = windowWidth / {{ page.width }};
        var maxRowHeight = windowHeight / {{ page.height }};

        var optimalSquareSize = Math.min(maxColWidth, maxRowHeight);

        var pageControlsDiv = document.getElementById("page-controls");
        pageControlsDiv.style.gridTemplateColumns = "repeat({{ page.width }}, " + optimalSquareSize + "px)";
        pageControlsDiv.style.gridTemplateRows = "repeat({{ page.height }}, " + optimalSquareSize + "px)";
    };
    setGridSize();
    window.addEventListener('resize', setGridSize);   
</script>

{% endblock %}
